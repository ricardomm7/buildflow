@startuml
skinparam monochrome true
skinparam packageStyle rectangle
skinparam shadowing false

autonumber

actor "User" as User
participant ":Simulator" as Simulator
participant "repositories\n:Repositories" as Repositories
participant "repository:\nProductPriorityLine" as ProductPriorityLine
participant "repository:\nWorkstationsPerOperation" as WorkstationsPerOperation
participant ":Product" as Product
participant ":Operation" as Operation
participant ":Workstation" as Workstation
participant ":MachineFlowAnalyzer" as MachineFlowAnalyzer

activate User

User -> Simulator : runWithPriority(boolean)
activate Simulator

Simulator -> Repositories : getProductPriorityRepository()
activate Repositories
Repositories --> Simulator : ProductPriorityLine
deactivate Repositories

Simulator -> Repositories : getWorkstationsPerOperation()
activate Repositories
Repositories --> Simulator : WorkstationsPerOperation
deactivate Repositories

Simulator -> ProductPriorityLine : getProductsByPriority(PriorityOrder)
activate ProductPriorityLine
ProductPriorityLine --> Simulator : List<Product>
deactivate ProductPriorityLine

loop Process each priority level
    Simulator -> Simulator : returnToFirstOp(List<Product>)

    loop Process each product
        Simulator -> Product : getCurrentOperation()
        activate Product
        Product --> Simulator : Operation
        deactivate Product

        Simulator -> WorkstationsPerOperation : getWorkstationsByOperation(Operation, boolean)
        activate WorkstationsPerOperation
        WorkstationsPerOperation --> Simulator : List<Workstation>
        deactivate WorkstationsPerOperation

        alt Workstation available
            Simulator -> Workstation : processProduct(Product)
            activate Workstation
            Workstation --> Simulator : operationTime
            deactivate Workstation

            Simulator -> Simulator : updateProductAndOperationTimes()
            Simulator -> Product : moveToNextOperation()
            activate Product
            Product --> Simulator : boolean
            deactivate Product

            alt All operations completed
                Simulator -> Simulator : add to processedProducts
            end

        else No available workstation
            Simulator -> Simulator : addToWaitingQueue(Product, Operation)
        end
    end

    Simulator -> Simulator : processWaitingQueue()

end

Simulator -> MachineFlowAnalyzer : calculateMachineDependencies()
activate MachineFlowAnalyzer
MachineFlowAnalyzer --> Simulator : dependencies calculated
deactivate MachineFlowAnalyzer

Simulator --> User : Processing results
deactivate Simulator
deactivate User

@enduml
